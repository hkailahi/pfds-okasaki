# Ch 8 - Lazy Rebuilding

- [Ch 8 - Lazy Rebuilding](#ch-8---lazy-rebuilding)
  - [Achieving Balance](#achieving-balance)
  - [Batched Rebuilding](#batched-rebuilding)
    - [Red Black Trees](#red-black-trees)
  - [Global Rebuilding](#global-rebuilding)
    - [Eliminating Amortization - Similarites to Real-Time Queue](#eliminating-amortization---similarites-to-real-time-queue)
  - [Lazy Rebuilding](#lazy-rebuilding)
    - [Hood-Melville Queues](#hood-melville-queues)

## Achieving Balance

> For most balanced structures, there is a notion of *perfect balance*, which is a configuration that minimizes the cost of subsequent operations. However, since it is usually too expensive to restore perfect balance after every update, most implementations settle for approximations of perfect balance that are at most a constant factor slower (Ex. AVL trees, red-black trees)
- PFDS pg. 99 (8.1 Batched Rebuilding)

## Batched Rebuilding

Batch rebuilding similar to the amortization strategy of the banker's queue.

### Red Black Trees

## Global Rebuilding

> (**Global rebuilding** is) a technique for eliminating the amortization from batched rebuilding (...) The basic idea is to execute the rebuilding transformation incrementally, performing a few steps per normal operation. This can be usefully viewed as running the rebuilding transformation as a **coroutine**. The tricky part of **global rebuilding** is that the coroutine must be started early enough that it can finish by the time the rebuilt structure is needed.

> Concretely, **global rebuilding** is accomplished by maintaining two copies of each object. The **primary**, or **working**, copy is the ordinary structure. The **secondary copy** is the one that is being gradually rebuilt. All queries and updates operate on the working copy. When the secondary copy is completed, it becomes the new working copy and the old working copy is discarded. A new secondary copy might be started immediately, or the object may carry on for a while without a secondary structure, before eventually starting the next rebuilding phase.

### Eliminating Amortization - Similarites to Real-Time Queue

Global rebuilding reminded me to the strategy of elimination amortization in the **real-time queue**. The **real-time queue**, from here on RTQ, kept primary copy of queue split between a forward front list and reversed rear list. Rather than a secondary copy, the RTQ keeps a schedule of unevaluated work.

On each update operation, some unevaluated debt is paid and removed from the schedule. Each operation performs enough of an incremental rotation such that whenever a new rebalancing/frontloading is required, the previous reversal has been completed.

```
λ> demoRTQ 20
┌──────────────────────────────────────────┬──────────────────────────────────────────┬──────────────────────────────────────────┬──────────────────────────────────────────┐
│                 Command                  │                  Front                   │                   Rear                   │                 Schedule                 │
╞══════════════════════════════════════════╪══════════════════════════════════════════╪══════════════════════════════════════════╪══════════════════════════════════════════╡
│                  empty                   │                    []                    │                    []                    │                    []                    │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 1                  │                   [_1]                   │                    []                    │                   [1]                    │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 2                  │                   [1]                    │                   [2]                    │                    []                    │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 3                  │                 [_1,_2,_3]               │                    []                    │                 [1,2,3]                  │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 4                  │                 [1,_2,_3]                │                   [4]                    │                  [2,3]                   │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 5                  │                 [1,2,_3]                 │                  [5,4]                   │                   [3]                    │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 6                  │                 [1,2,3]                  │                 [6,5,4]                  │                    []                    │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 7                  │             [_1,_2,_3,_4,_5,_6,_7]       │                    []                    │             [1,2,3,4,5,6,7]              │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 8                  │             [1,_2,_3,_4,_5,_6,_7]        │                   [8]                    │              [2,3,4,5,6,7]               │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                  snoc 9                  │             [1,2,_3,_4,_5,_6,_7]         │                  [9,8]                   │               [3,4,5,6,7]                │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                 snoc 10                  │             [1,2,3,_4,_5,_6,_7]          │                 [10,9,8]                 │                [4,5,6,7]                 │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                 snoc 11                  │             [1,2,3,4,_5,_6,_7]           │               [11,10,9,8]                │                 [5,6,7]                  │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                 snoc 12                  │             [1,2,3,4,5,_6,_7]            │              [12,11,10,9,8]              │                  [6,7]                   │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                 snoc 13                  │             [1,2,3,4,5,6,_7]             │            [13,12,11,10,9,8]             │                   [7]                    │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                 snoc 14                  │             [1,2,3,4,5,6,7]              │           [14,13,12,11,10,9,8]           │                    []                    │
├──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────┤
│                 snoc 15                  │  [_1,_2,_3,_4,_5,_6,_7,_8,_9,            │                    []                    │  [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]   │
│                                          │   _10,_11,_12,_13,_14,_15]               │                                          │                                          │
└──────────────────────────────────────────┴──────────────────────────────────────────┴──────────────────────────────────────────┴──────────────────────────────────────────┘
```

## Lazy Rebuilding

### Hood-Melville Queues


**Hood-Melville Queues**, from here on **HMQ**, is a **real-time-queue** implementation. Unlike **global rebuilding**, HMQs do not execute the rebuilding transformation (i.e., the rotation) concurrently with the normal operations; rather, it pays for the rebuilding transformation concurrently with the normal operations, but then executes the transformation all at once at some point after it has been paid for.

In essence, we have replaced the complications of explicitly or implicitly coroutining the rebuilding transformation with the simpler mechanism of lazy evaluation. We call this variant of global rebuilding **lazy rebuilding**.

```
λ> demoHMQ 20
┌───────────────────────┬─────────┬───────────────────────┬──────────────────────────────────────────────────────────────┬─────────┬───────────────────────┐
│        Command        │ Size(F) │         Front         │                           Rotation                           │ Size(R) │         Rear          │
╞═══════════════════════╪═════════╪═══════════════════════╪══════════════════════════════════════════════════════════════╪═════════╪═══════════════════════╡
│         empty         │    0    │          []           │                             Idle                             │    0    │          []           │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 1         │    1    │          [1]          │                             Idle                             │    0    │          []           │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 2         │    1    │          [1]          │                             Idle                             │    1    │          [2]          │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 3         │    3    │          [1]          │                    Appending 1 [1] [2,3]                     │    0    │          []           │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 4         │    3    │        [1,2,3]        │                             Idle                             │    1    │          [4]          │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 5         │    3    │        [1,2,3]        │                             Idle                             │    2    │         [5,4]         │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 6         │    3    │        [1,2,3]        │                             Idle                             │    3    │        [6,5,4]        │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 7         │    7    │        [1,2,3]        │              Reversing 2 [3] [2,1] [5,4] [6,7]               │    0    │          []           │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 8         │    7    │        [1,2,3]        │                Appending 3 [3,2,1] [4,5,6,7]                 │    1    │          [8]          │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 9         │    7    │        [1,2,3]        │                Appending 1 [1] [2,3,4,5,6,7]                 │    2    │         [9,8]         │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 10        │    7    │    [1,2,3,4,5,6,7]    │                             Idle                             │    3    │       [10,9,8]        │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 11        │    7    │    [1,2,3,4,5,6,7]    │                             Idle                             │    4    │      [11,10,9,8]      │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 12        │    7    │    [1,2,3,4,5,6,7]    │                             Idle                             │    5    │    [12,11,10,9,8]     │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 13        │    7    │    [1,2,3,4,5,6,7]    │                             Idle                             │    6    │   [13,12,11,10,9,8]   │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 14        │    7    │    [1,2,3,4,5,6,7]    │                             Idle                             │    7    │ [14,13,12,11,10,9,8]  │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 15        │   15    │    [1,2,3,4,5,6,7]    │   Reversing 2 [3,4,5,6,7] [2,1] [13,12,11,10,9,8] [14,15]    │    0    │          []           │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 16        │   15    │    [1,2,3,4,5,6,7]    │   Reversing 4 [5,6,7] [4,3,2,1] [11,10,9,8] [12,13,14,15]    │    1    │         [16]          │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 17        │   15    │    [1,2,3,4,5,6,7]    │   Reversing 6 [7] [6,5,4,3,2,1] [9,8] [10,11,12,13,14,15]    │    2    │        [17,16]        │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 18        │   15    │    [1,2,3,4,5,6,7]    │     Appending 7 [7,6,5,4,3,2,1] [8,9,10,11,12,13,14,15]      │    3    │      [18,17,16]       │
├───────────────────────┼─────────┼───────────────────────┼──────────────────────────────────────────────────────────────┼─────────┼───────────────────────┤
│        snoc 19        │   15    │    [1,2,3,4,5,6,7]    │     Appending 5 [5,4,3,2,1] [6,7,8,9,10,11,12,13,14,15]      │    4    │     [19,18,17,16]     │
└───────────────────────┴─────────┴───────────────────────┴──────────────────────────────────────────────────────────────┴─────────┴───────────────────────┘
```
